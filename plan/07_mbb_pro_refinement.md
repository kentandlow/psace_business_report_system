# MBB（戦略コンサル）グレード・出力精度向上および白紙バグ修正・Proモデル移行計画

## 1. 背景と課題
Step 1・2の実装によりJSONスキーマの高度化と描画ロジックが組み込まれましたが、**「出力されたPPTXの各スライドが白紙（タイトルのみ）になってしまう」**という問題が発生しました。

**【原因の仮説】**
1. **AIの命令無視（スキーマ不一致）**: 
   軽量モデル（Flash）を使用しているため、複雑なSystem Instructionを無視してしまい、旧フォーマットの `content` キーを出力したり、必須の `insights` や `visuals` を出力しなかった結果、`generator.py` が描画をスキップして白紙になっている可能性が高い。
2. **グラフデータの型エラー**:
   グラフ用の `values` 配列に文字列（例: `"100億円"`）を出力してしまい、`generator.py` の `float(v)` 変換でクラッシュしてグラフが描画されていない。

## 2. 解決策：Claude Code への実装指示

Claude Codeを使用して、以下の 3 つの改修を実行してください。

### ① Gemini APIのモデルを「Pro」へアップグレード (analyzer.py)
現在使用している `gemini-2.5-flash`（または1.5-flash）は高速ですが、深い洞察や複雑なJSON生成において命令を無視することがあります。より推論能力が高く、MBBレベルの深いインサイトを抽出できる **Proモデル** へ変更してください。
* `analyzer.py` の `model_name` を **`gemini-2.5-pro`** に変更してください。
* （※もし `gemini-2.5-pro` が 404 エラーとなる場合は、**`gemini-1.5-pro-latest`** を使用してください）

### ② プロンプトへの「Few-Shot（出力例）」の追加 (analyzer.py)
AIが確実に指定されたキー（`lead_message`, `insights`, `visuals`）を出力するよう、`SYSTEM_INSTRUCTION` またはプロンプト内に**「1スライド分の完璧な出力JSONのサンプル（Few-Shot Example）」**を追記してください。
また、`visuals.values` には**「絶対に単位（$や円）を含めない純粋な数値のみを入れること」**を強く指示に含めてください。

### ③ 空白スライドを防ぐ robust なフォールバック処理 (generator.py)
AIが万が一期待通りのJSONを出力しなかった場合でも、スライドが白紙になることを防ぐための安全網（フォールバック）を `generator.py` に追加してください。
* スライド描画処理（`_build_content_slide`）の冒頭でデータを取得する際、`insights` が空で、もし古いキーの `content` が存在していれば、それを `insights` の代わりとして読み込むように修正する。
* `lead_message` が無い場合は、タイトルをそのまま入れるか、または代替テキストを入れる。
* グラフ（chart）の `values` の型変換時、数値以外が混じっていてもクラッシュせず、エラーを無視（あるいは0に置換）してプログラムが止まらないように `try-except` を各データポイントの変換に挟む。

---

## Claude Code への実行コマンド例（プロンプト）

```text
GitHub Actionsで実行したところスライドの内容が白紙になってしまいました。分析の精度と密度を最高（マッキンゼー・BCGレベル）に引き上げるため、plan/07_mbb_pro_refinement.md を読み込み、以下の3点を実装してください。

1. analyzer.py のモデルを `gemini-2.5-pro` (または `gemini-1.5-pro-latest`) に変更して分析力を高める。
2. analyzer.py のプロンプトに、確実なJSON出力を促すための「 Few-Shot Example（完全な出力例）」と、「グラフの値には文字列を含めず数値のみを入れる」という強い制約を追加する。
3. generator.py を修正し、AIが insights キーを返し忘れて content キーを返した場合のフォールバック処理や、型変換エラーでの白紙化を防ぐ堅牢なエラーハンドリングを追加する。
```
