name: 宇宙ビジネス動向レポート 週次自動生成

on:
  schedule:
    # UTC 月曜 00:00 = JST 月曜 09:00
    - cron: '0 0 * * 1'
  workflow_dispatch:  # GitHub 画面から手動実行も可能
    inputs:
      start_date:
        description: '対象期間の開始日 (例: 2026-02-16) 空白で直近30日'
        required: false
        type: string
      end_date:
        description: '対象期間の終了日 (例: 2026-02-20) 空白で直近30日'
        required: false
        type: string

jobs:
  generate-report:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ----------------------------------------------------------------
      # 1. リポジトリの Checkout
      # ----------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------------------
      # 2. Python 環境のセットアップ
      # ----------------------------------------------------------------
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # ----------------------------------------------------------------
      # 3. PDF 生成に必要なシステムパッケージをインストール
      #    xhtml2pdf（純 Python）は GTK 不要。日本語フォントのみ追加する
      # ----------------------------------------------------------------
      - name: Install system dependencies for PDF generation
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            fonts-noto-cjk \
            libcairo2-dev \
            pkg-config \
            python3-dev

      # ----------------------------------------------------------------
      # 4. 依存パッケージのインストール
      # ----------------------------------------------------------------
      - name: Install Python dependencies
        run: pip install -r requirements.txt

      # ----------------------------------------------------------------
      # 5. .env ファイルの生成 (Secrets から取得)
      # ----------------------------------------------------------------
      - name: Create .env file
        run: |
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env

      # ----------------------------------------------------------------
      # 6. メインスクリプトの実行
      #    念のため直接環境変数としても渡し、空でないかチェックする
      # ----------------------------------------------------------------
      - name: Generate space business report
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          START_DATE: ${{ github.event.inputs.start_date }}
          END_DATE: ${{ github.event.inputs.end_date }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "::error::GEMINI_API_KEY is empty in GitHub Secrets!"
            exit 1
          else
            echo "GEMINI_API_KEY is properly loaded from Secrets."
          fi
          python src/main.py

      # ----------------------------------------------------------------
      # 7. 生成された PDF・Markdown レポートを Artifacts に保存（30 日間保持）
      # ----------------------------------------------------------------
      - name: Upload report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: space-report-${{ github.run_id }}
          path: |
            output/*.pdf
            output/*.md
          retention-days: 30
          if-no-files-found: warn

      # ----------------------------------------------------------------
      # 8. 収集・分析の中間データも保存（デバッグ用、7 日間保持）
      # ----------------------------------------------------------------
      - name: Upload intermediate data as artifact
        uses: actions/upload-artifact@v4
        with:
          name: intermediate-data-${{ github.run_id }}
          path: |
            data/raw_news.json
            data/analyzed_report.md
          retention-days: 7
          if-no-files-found: warn
