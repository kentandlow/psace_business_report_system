# マークダウン形式の詳細レポート生成への移行計画

## 1. 背景と課題
APIキーを更新した後も、Gemini APIの呼び出し途中で `400 API key expired` または `API_KEY_INVALID` 等のエラーが発生しました。
大量のスライド生成（全30枚・複数回のAPIリクエスト）によって、一時的な無料枠のレートリミット超過やクォータ制限のペナルティを受けている可能性が高い状態です。

**今後の方向性**:
スライド（PPTX）という形式に固執せず、**「マッキンゼー・BCGレベルの分析精度とボリュームはそのまま維持する」**ことを最優先とし、**出力形式を「マークダウン（Markdown）」の単一ファイル・詳細レポート形式へ変更**します。
これによりAPIコール回数を極限まで減らし（1〜数回程度）、エラー率を大幅に下げつつ、より長文で複雑な分析結果を得ることができます。

## 2. 実装計画（Claude Code への指示）

### ① `analyzer.py` の改修：プロンプトと出力スキーマの変更
JSONでの細切れのスライド定義をやめ、**セクションごとに美しく構造化されたMarkdown形式の長文レポート**を生成させるように修正します。

* **APIリクエストの統合**: 
  カテゴリごと（政策、研究、ビジネス等）にテキストをまとめ、1回または数回のAPIリクエストで全体のMarkdownを生成するように変更します。
  これによりレートリミットを回避します。
* **モデルの維持/向上**:
  `gemini-2.5-pro`（または `1.5-pro`）を使用し、高い推論能力を維持します。
* **出力フォーマットの指示**:
  JSONではなく、そのままのMarkdownテキストとして出力させます。指示を以下のように強化します。
  - 「マッキンゼーやBCGが作成するような、極めて論理的でインサイトに富んだ週次レポートをMarkdown形式で記述してください。」
  - 「単なる元ニュースの要約ではなく、必ず『So What?（だから何？）』『Impact（業界への影響）』『Future Outlook（今後の展望）』を各トピックに含めること。」
  - 「適宜、Markdownの表（Table）を用いて、企業間の比較や動向の整理を行うこと。」

### ② `generator.py` の廃止または改修
PPTX生成モジュールである `generator.py` は役割を終えます。
代わりに、`analyzer.py` が生成したMarkdownテキスト（例: `data/analyzed_report.md`）をそのまま成果物とするか、あるいは `generator.py` を「Markdownから美しいHTMLやPDFを出力するツール（例えば `markdown` や `pdfkit` を使用）」に作り替えることも考えられます。
まずは一番シンプルな、**「Markdownファイルを成果物として保存するだけ」**の処理に変更します。

### ③ `main.py` および GitHub Actions の修正
* 生成される成果物が `.pptx` ではなく `.md`（または `.html`）になるため、`main.py` の完了ログや Actions の Artifacts アップロードの拡張子（`output/*.md` 等）を修正します。

---

## Claude Code への実行コマンド例（プロンプト）

Claude Codeを起動して、以下のプロンプトを実行してください。

```text
Gemini APIのエラー（レート制限やクォータ問題と推測されます）により、30枚のPPTX生成は安定しないことが判明しました。そこで、「分析精度や内容のボリューム（MBBレベルの質）はそのまま維持し、出力フォーマットを詳細なマークダウン（Markdown）形式のレポートに変更する」という仕様変更を行います。
plan/08_markdown_report_migration.md を読み込み、以下のタスクを実行してください。

1. analyzer.py を抜本的に修正する。
   - JSON（スライドごとのデータ）を出力するのではなく、美しいMarkdownテキストの長文レポートを出力させるプロンプトに変更する。
   - カテゴリ（政策、研究、ビジネス、資金調達など）ごとに複数回APIを叩くのではなく、極力リクエスト回数を減らしてレート制限を回避する。
   - プロンプトでは、「So What?」「Impact」「今後の展望」を含めたコンサル品質の分析を要求し、表（Table）構造も出力させること。
   - モデルは gemini-2.5-pro (または 1.5-pro) を指定する。
2. generator.py を修正する（または削除する）。
   - PPTX生成処理は廃止し、analyzer.pyが出力したMarkdownをそのまま output/ ディレクトリ等に保存するだけのシンプルな処理にするか、analyzer.pyに統合する。
3. main.py および .github/workflows/space_report.yml を修正し、最終的な出力物が Markdown (.md) になるように成果物のパス等を変更する。
```
